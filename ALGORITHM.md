# Алгоритм работы бота управления расписанием сотрудников

## Глобальная цель
Управление распределением сотрудников в офисах с учетом ограничения в 8 посадочных мест в день.

## Расписание по умолчанию
- **Понедельник**: Вася, Дима Ч, Айлар, Егор, Илья, Даша, Виталий, Тимур
- **Вторник**: Вася, Дима Ч, Айдан, Дима А, Тимур, Рома, Костя, Леша Б
- **Среда**: Дима Ч, Илья, Тимур, Костя, Катя, Артем, Рома, Марк
- **Четверг**: Вася, Дима Ч, Толя, Глеб, Тимур, Рома, Леша Б, Марк
- **Пятница**: Вася, Дима Ч, Айлар, Егор, Илья, Даша, Виталий, Тимур

## Основные правила
1. Всего 8 мест в день в офисе
2. Если для сотрудника нет места в день - работа удаленно
3. Сотрудники могут пропускать свои дни
4. Сотрудники могут просить дополнительные дни (если есть свободные места)

## Структура данных

### Хранение расписаний
- Формат: TXT файлы в папке `schedules/`
- Структура файлов:
  - `default_schedule.txt` - расписание по умолчанию
  - `YYYY-MM-DD.txt` - расписание на конкретную дату
  - `employees.txt` - список всех сотрудников с их Telegram ID

### Формат файла расписания на дату
```
YYYY-MM-DD
Понедельник
Вася, Дима Ч, Айлар, Егор, Илья, Даша, Виталий, Тимур
Вторник
Вася, Дима Ч, Айдан, Дима А, Тимур, Рома, Костя, Леша Б
...
```

## Алгоритм работы бота

### 1. Инициализация
- При первом запуске создается расписание по умолчанию
- Загружаются все сотрудники из `employees.txt`
- Создается расписание на 2 месяца вперед на основе расписания по умолчанию

### 2. Еженедельный цикл

#### Пятница (конец рабочего дня, ~18:00)
- Бот отправляет всем сотрудникам напоминание:
  ```
  Напоминание: до воскресенья вечера укажите дни, когда вам нужно быть в офисе на следующей неделе.
  Используйте команду /set_week_days или ответьте на это сообщение списком дней (например: "пн, вт, чт")
  ```

#### Суббота-Воскресенье
- Бот собирает заявки от сотрудников на следующую неделю
- Сотрудники могут указать:
  - Дни, когда им нужно быть в офисе (даже если их нет в расписании по умолчанию)
  - Дни, которые они пропускают (даже если они есть в расписании по умолчанию)

#### Воскресенье вечером (после 20:00)
- Бот анализирует все заявки
- Формирует финальное расписание на неделю
- Рассылает всем сотрудникам информацию:
  ```
  Ваше расписание на неделю [даты]:
  
  Дни в офисе: Пн, Вт, Чт
  Дни удаленно: Ср, Пт
  
  Свободные места:
  - Среда: есть 2 свободных места (кто-то пропустил)
  - Пятница: есть 1 свободное место
  ```

### 3. Команды бота

#### `/start` или `/help`
- Показывает список доступных команд

#### `/set_week_days [дни]`
- Установить дни на следующую неделю
- Пример: `/set_week_days пн вт чт`
- Или: `/set_week_days понедельник вторник четверг`

#### `/my_schedule [неделя]`
- Показать свое расписание на неделю
- Если не указана неделя - показывает следующую

#### `/full_schedule [дата]`
- Показать полное расписание на дату (только для админов)

#### `/skip_day [дата]`
- Пропустить день в расписании
- Пример: `/skip_day 2024-12-20`

#### `/add_day [дата]`
- Запросить дополнительный день в офисе
- Пример: `/add_day 2024-12-20`

#### `/admin_add_employee [имя] [telegram_id]`
- Добавить нового сотрудника (только для админов)

### 4. Обработка заявок

#### Сбор заявок
- Бот хранит заявки в файле `requests/YYYY-MM-DD_requests.txt`
- Формат заявки:
  ```
  employee_name:telegram_id:week_start_date:days_requested:days_skipped
  ```

#### Формирование расписания
1. Начинаем с расписания по умолчанию
2. Применяем пропуски (удаляем сотрудников из дней)
3. Применяем дополнительные заявки (добавляем сотрудников в дни, если есть место)
4. Проверяем ограничение в 8 мест
5. Если мест не хватает - приоритет по времени заявки

### 5. Уведомления

#### Автоматические напоминания
- Пятница 18:00 - напоминание о необходимости указать дни
- Воскресенье 20:00 - рассылка финального расписания

#### Уведомления о свободных местах
- После формирования расписания бот проверяет для каждого сотрудника:
  - Есть ли свободные места в дни, которых у него нет в расписании
  - Если есть - отправляет уведомление

### 6. Хранение истории
- Все расписания сохраняются в `schedules/YYYY-MM-DD.txt`
- История заявок в `requests/YYYY-MM-DD_requests.txt`
- Ретро-периоды доступны для просмотра через команды

## Технические детали

### Используемые библиотеки
- `aiogram` - для работы с Telegram Bot API
- `asyncio` - для асинхронной работы
- `datetime`, `pytz` - для работы с датами
- `schedule` или `APScheduler` - для планирования задач

### Структура файлов проекта
```
office_schedule_bot/
├── main.py                 # Основной файл бота
├── config.py               # Конфигурация (токены, настройки)
├── schedule_manager.py     # Управление расписаниями
├── employee_manager.py     # Управление сотрудниками
├── notification_manager.py # Управление уведомлениями
├── data/
│   ├── schedules/          # Файлы расписаний
│   ├── requests/           # Файлы заявок
│   └── employees.txt       # Список сотрудников
├── requirements.txt
├── README.md
└── ALGORITHM.md            # Этот файл
```

