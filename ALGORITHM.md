# Алгоритм работы бота управления расписанием сотрудников

## Глобальная цель
Управление распределением сотрудников в офисах с учетом ограничения в 8 посадочных мест в день. Каждое место имеет уникальный идентификатор в формате `подразделение.номер_места` (например, `1.1`, `1.2`, `1.3` и т.д.).

## Расписание по умолчанию
Расписание по умолчанию хранится в формате JSON, где каждому дню соответствует словарь мест:
- **Понедельник**: `{'1.1': 'Дима Ч', '1.2': 'Тимур', '1.3': 'Вася', ...}`
- **Вторник**: `{'1.1': 'Дима Ч', '1.2': 'Тимур', '1.3': 'Вася', ...}`
- И так далее для всех дней недели

Каждый сотрудник имеет закрепленное место на основе приоритета (количество дней в неделю). Сотрудники с большим количеством дней получают более стабильные места.

## Основные правила
1. Всего 8 мест в день в офисе (формат: `1.1`, `1.2`, ..., `1.8`)
2. Если для сотрудника нет места в день - работа удаленно
3. Сотрудники могут пропускать свои дни
4. Сотрудники могут просить дополнительные дни (если есть свободные места)
5. При отображении расписания сотрудники сортируются по возрастанию номера места
6. Имена сотрудников отображаются в формате `Имя(@username)` если есть username

## Структура данных

### Хранение данных
**Приоритет:** Google Sheets → Локальные файлы (fallback)

Все данные хранятся в Google Sheets (если настроено) или в локальных файлах:
- **Google Sheets** (основной источник):
  - `employees` - список сотрудников
  - `admins` - список администраторов
  - `default_schedule` - расписание по умолчанию (JSON формат)
  - `pending_employees` - отложенные записи для сотрудников, добавленных по username
  - `schedules` - расписания на конкретные даты
  - `requests` - заявки сотрудников
  - `queue` - очередь на дни
  - `logs` - логи всех команд и ответов

- **Локальные файлы** (fallback):
  - `data/schedules/YYYY-MM-DD.txt` - расписание на конкретную дату
  - `data/requests/YYYY-MM-DD_requests.txt` - заявки на неделю
  - `data/employees.txt` - список сотрудников
  - `data/admins.txt` - список администраторов
  - `data/queue/YYYY-MM-DD_queue.txt` - очередь на день
  - `data/default_schedule.txt` - расписание по умолчанию (JSON)

### Формат файла employees.txt
```
manual_name:telegram_name:telegram_id:username
Рома:Roman:312551109:rsidorenkov
Вася:Vasily:586507227:vbronsky
```

### Формат default_schedule (JSON)
```json
{
  "Понедельник": {
    "1.1": "Дима Ч(@dmitrii_chep)",
    "1.2": "Тимур",
    "1.3": "Вася(@vbronsky)",
    ...
  },
  "Вторник": {
    "1.1": "Дима Ч(@dmitrii_chep)",
    ...
  }
}
```

### Формат файла очереди
```
employee_name:telegram_id
Рома:312551109
```

## Алгоритм работы бота

### 1. Инициализация
- При первом запуске загружаются данные из Google Sheets (приоритет) или локальных файлов
- Создается расписание по умолчанию (если отсутствует)
- Загружаются все сотрудники
- Обновляются имена сотрудников в default_schedule (добавляются username в скобках)

### 2. Регистрация сотрудников
- Админ добавляет сотрудника через `/admin_add_employee [имя] @username` или `/admin_add_employee [имя] [telegram_id]`
- Если сотрудник добавлен по username, создается запись в `pending_employees`
- Когда сотрудник пишет `/start`:
  - Если есть запись в `pending_employees`, используется `manual_name` из нее
  - Сотрудник регистрируется в системе
  - Автоматически обновляется `default_schedule` в Google Sheets: имя сотрудника заменяется на форматированное с username (например, "Рома" → "Рома(@rsidorenkov)")
- Сотрудники, добавленные админом, получают полный доступ к функциям бота
- Сотрудники, зарегистрировавшиеся самостоятельно через `/start`, получают ограниченный доступ и должны быть добавлены админом

### 3. Еженедельный цикл

#### Пятница (конец рабочего дня, ~18:00)
- Бот отправляет всем сотрудникам напоминание:
  ```
  Напоминание: до воскресенья вечера укажите дни, когда вам нужно быть в офисе на следующей неделе.
  Используйте команду /set_week_days или ответьте на это сообщение списком дней (например: "пн, вт, чт")
  ```

#### Суббота-Воскресенье
- Бот собирает заявки от сотрудников на следующую неделю
- Сотрудники могут указать:
  - Дни, когда им нужно быть в офисе (даже если их нет в расписании по умолчанию)
  - Дни, которые они пропускают (даже если они есть в расписании по умолчанию)

#### Воскресенье вечером (после 20:00)
- Бот анализирует все заявки
- Обрабатывает очередь для каждого дня следующей недели (если есть свободные места)
- Формирует финальное расписание на неделю
- Рассылает всем сотрудникам информацию:
  ```
  Ваше расписание на неделю [даты]:
  
  Дни в офисе: Пн (место 1.6), Вт (место 1.6), Чт (место 1.6)
  Дни удаленно: Ср, Пт
  
  Дополнительно запрошенные дни:
  ✅ Пт - место найдено
  ❌ Ср - свободного места не нашлось
  
  Свободные места:
  - Среда: 1 место(а)
  ```

### 4. Команды бота

#### `/start`
- Регистрирует пользователя в системе
- Если пользователь был добавлен админом (через pending_employees), автоматически обновляет default_schedule в Google Sheets с добавлением username
- Показывает приветственное сообщение и список команд
- Если пользователь не был добавлен админом, информирует о необходимости обратиться к администратору

#### `/help`
- Показывает список всех доступных команд с примерами

#### `/set_week_days [даты]`
- Установить дни на следующую неделю
- Поддерживает даты: `/set_week_days 2024-12-23 2024-12-24 2024-12-26`
- Также поддерживает названия дней: `/set_week_days пн вт чт`
- Перезаписывает предыдущую заявку пользователя на ту же неделю
- Показывает гарантированные дни (из default_schedule) и дополнительные запрошенные дни

#### `/my_schedule`
- Показать свое расписание на текущую неделю
- Отображает дни в офисе с указанием места (например, "Пн (место 1.6)")
- Использует сохраненные расписания или строит из заявок

#### `/full_schedule [дата]`
- Показать полное расписание на дату (только для админов)
- Отображает всех сотрудников с их местами в формате: `1.1: Имя(@username), 1.2: Имя, ...`
- Сотрудники отсортированы по возрастанию номера места

#### `/skip_day [дата]`
- Пропустить день в расписании (можно указать несколько дат)
- Пример: `/skip_day 2024-12-20`
- Пример: `/skip_day 2024-12-20 2024-12-21`
- Для текущей недели: удаляет из расписания, обрабатывает очередь
- Для следующей недели: добавляет в список пропусков

#### `/add_day [дата]`
- Запросить дополнительный день в офисе (можно указать несколько дат)
- Пример: `/add_day 2024-12-20`
- Пример: `/add_day 2024-12-20 2024-12-21`
- Для текущей недели: добавляет в расписание или в очередь, если места нет
- Для следующей недели: добавляет в список запрошенных дней

#### `/admin_add_employee [имя] @username`
- Добавить нового сотрудника (только для админов)
- Также можно: `/admin_add_employee [имя] [telegram_id]`
- Или ответить на сообщение: `/admin_add_employee [имя]`
- Если имя уже используется другим сотрудником, админ получает уведомление с информацией о текущем владельце
- Если сотрудник добавлен по username, создается запись в `pending_employees`
- После добавления обновляется `default_schedule` с форматированным именем

#### `/admin_skip_day @username [дата]`
- Пропустить день для сотрудника (только для админов)
- Можно указать несколько дат
- Пример: `/admin_skip_day @username 2024-12-20 2024-12-21`

#### `/admin_add_day @username [дата]`
- Добавить день для сотрудника (только для админов)
- Можно указать несколько дат
- Пример: `/admin_add_day @username 2024-12-20 2024-12-21`

#### `/admin_list_admins`
- Показать список администраторов с их Telegram ID и username

#### `/admin_add_admin @username`
- Добавить администратора по username или telegram_id

#### `/admin_set_default_schedule [день] [список сотрудников]`
- Установить расписание по умолчанию для дня (только для админов)
- Пример: `/admin_set_default_schedule Понедельник Вася, Дима Ч, Айлар, Егор, Илья, Даша, Виталий, Тимур`
- Сохраняет расписание в Google Sheets в формате JSON с местами

#### `/admin_test_schedule`
- Тестовая рассылка расписания на следующую неделю (только для админов)
- Отправляет расписание только администраторам

### 5. Обработка заявок

#### Сбор заявок
- Бот хранит заявки в Google Sheets (лист `requests`) или в файле `requests/YYYY-MM-DD_requests.txt`
- Формат заявки:
  ```
  week_start:employee_name:telegram_id:days_requested:days_skipped
  ```
- Если пользователь отправляет несколько заявок на одну неделю, сохраняется только последняя

#### Формирование расписания
1. Начинаем с расписания по умолчанию (с закрепленными местами)
2. Применяем пропуски (удаляем сотрудников из дней)
3. Применяем дополнительные заявки (добавляем сотрудников в дни, если есть место)
4. Проверяем ограничение в 8 мест
5. Обрабатываем очередь для каждого дня (если есть свободные места)
6. Если мест не хватает - сотрудник работает удаленно или остается в очереди
7. Сохраняем финальное расписание в Google Sheets или локальные файлы

### 6. Система очередей

#### Работа с очередью для текущей недели
- При использовании `/add_day` для текущей недели:
  - Если есть место - сотрудник добавляется в расписание
  - Если места нет - сотрудник добавляется в очередь (`data/queue/YYYY-MM-DD_queue.txt` или Google Sheets)
- При использовании `/skip_day` для текущей недели:
  - Если сотрудник в расписании - удаляется, освобождается место
  - Если сотрудник в очереди - удаляется из очереди
  - После освобождения места автоматически обрабатывается очередь (первый из очереди добавляется)

#### Обработка очереди для следующей недели
- При формировании расписания в воскресенье вечером:
  - После применения всех заявок проверяется каждый день следующей недели
  - Если есть свободные места - обрабатывается очередь для этого дня
  - Первый из очереди автоматически добавляется в расписание

### 7. Уведомления

#### Автоматические напоминания
- Пятница 18:00 - напоминание о необходимости указать дни
- Воскресенье 20:00 - рассылка финального расписания

#### Уведомления о свободных местах
- После формирования расписания бот проверяет для каждого сотрудника:
  - Есть ли свободные места в дни, которых у него нет в расписании
  - Если есть - отправляет уведомление
- При освобождении места в текущей неделе:
  - Уведомляются все сотрудники (кроме тех, кто уже в офисе)
  - Первый из очереди автоматически добавляется и получает уведомление

### 8. Хранение истории
- Все расписания сохраняются в Google Sheets (лист `schedules`) или `schedules/YYYY-MM-DD.txt`
- История заявок в Google Sheets (лист `requests`) или `requests/YYYY-MM-DD_requests.txt`
- Очереди в Google Sheets (лист `queue`) или `queue/YYYY-MM-DD_queue.txt`
- Логи всех команд в Google Sheets (лист `logs`) - логи не сохраняются в локальные файлы
- Ретро-периоды доступны для просмотра через команды

### 9. Управление сотрудниками и администраторами
- Формат `employees.txt`: `manual_name:telegram_name:telegram_id:username`
- Ежедневно в 03:00 выполняется схлопывание дубликатов по `telegram_id`
- Администраторы хранятся в Google Sheets (лист `admins`) или `data/admins.txt` (по одному ID на строку)
- Администраторы могут управлять расписанием других сотрудников через `/admin_skip_day` и `/admin_add_day`
- При добавлении сотрудника по username создается запись в `pending_employees`, которая используется при первом `/start`

### 10. Приоритет мест
- Места назначаются сотрудникам на основе количества дней в неделю
- Сотрудники с большим количеством дней получают более стабильные места
- При пересчете расписания места остаются стабильными для сотрудников с одинаковым приоритетом (сортировка по имени как tie-breaker)
- Формат места: `подразделение.номер` (например, `1.1`, `1.2`, ..., `1.8`)

## Технические детали

### Используемые библиотеки
- `aiogram` - для работы с Telegram Bot API
- `asyncio` - для асинхронной работы
- `datetime`, `pytz` - для работы с датами
- `gspread`, `google-auth-oauthlib` - для работы с Google Sheets API
- `logging` - для логирования (только в Google Sheets)

### Структура файлов проекта
```
office_schedule_bot/
├── main.py                      # Основной файл бота
├── config.py                    # Конфигурация (токены, настройки)
├── schedule_manager.py          # Управление расписаниями
├── employee_manager.py          # Управление сотрудниками
├── admin_manager.py             # Управление администраторами
├── notification_manager.py      # Управление уведомлениями
├── google_sheets_manager.py     # Управление Google Sheets
├── logger.py                    # Логирование в Google Sheets
├── utils.py                     # Вспомогательные функции
├── init_data.py                 # Инициализация данных
├── data/                        # Локальные файлы (fallback)
│   ├── schedules/               # Файлы расписаний
│   ├── requests/                # Файлы заявок
│   ├── queue/                   # Очереди
│   ├── employees.txt            # Список сотрудников
│   ├── admins.txt               # Список администраторов
│   └── default_schedule.txt     # Расписание по умолчанию (JSON)
├── requirements.txt
├── README.md
├── ALGORITHM.md                 # Этот файл
├── google_sheets_setup.md       # Инструкции по настройке Google Sheets
└── railway_setup.md             # Инструкции по деплою на Railway
```

### Переменные окружения
- `BOT_TOKEN` - токен Telegram бота (если не указан в `config.py`)
- `GOOGLE_SHEETS_ID` - ID Google таблицы
- `GOOGLE_SHEETS_CREDENTIALS` - JSON credentials для Google Sheets API (минифицированный)

### Приоритет данных
1. **Google Sheets** - основной источник данных (если настроен)
2. **Локальные файлы** - fallback, если Google Sheets недоступен
3. **config.py** - начальные значения для default_schedule и admin_ids

### Логирование
- Все команды и ответы бота логируются в Google Sheets (лист `logs`)
- Логи не сохраняются в локальные файлы для экономии памяти
- Формат лога: `timestamp, user_id, username, first_name, command, response`
