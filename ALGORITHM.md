# Алгоритм работы бота управления расписанием сотрудников

## Глобальная цель
Управление распределением сотрудников в офисах с учетом ограничения в 8 посадочных мест в день.

## Расписание по умолчанию
- **Понедельник**: Вася, Дима Ч, Айлар, Егор, Илья, Даша, Виталий, Тимур
- **Вторник**: Вася, Дима Ч, Айдан, Дима А, Тимур, Рома, Костя, Леша Б
- **Среда**: Дима Ч, Илья, Тимур, Костя, Катя, Артем, Рома, Марк
- **Четверг**: Вася, Дима Ч, Толя, Глеб, Тимур, Рома, Леша Б, Марк
- **Пятница**: Вася, Дима Ч, Айлар, Егор, Илья, Даша, Виталий, Тимур

## Основные правила
1. Всего 8 мест в день в офисе
2. Если для сотрудника нет места в день - работа удаленно
3. Сотрудники могут пропускать свои дни
4. Сотрудники могут просить дополнительные дни (если есть свободные места)

## Структура данных

### Хранение расписаний
- Формат: TXT файлы в папке `schedules/`
- Структура файлов:
  - `default_schedule.txt` - расписание по умолчанию
  - `YYYY-MM-DD.txt` - расписание на конкретную дату
  - `employees.txt` - список всех сотрудников с их Telegram ID

### Формат файла расписания на дату
```
YYYY-MM-DD
Понедельник
Вася(@vbronsky), Дима Ч, Айлар, Егор, Илья, Даша, Виталий, Тимур
Вторник
Вася(@vbronsky), Дима Ч, Айдан(@Aydaaannnnn), Дима А, Тимур, Рома(@rsidorenkov), Костя, Леша Б
...
```

### Формат файла employees.txt
```
manual_name:telegram_name:telegram_id:username
Рома:Roman:312551109:rsidorenkov
Вася:Vasily:586507227:vbronsky
```

### Формат файла очереди
```
employee_name:telegram_id
Рома:312551109
```

## Алгоритм работы бота

### 1. Инициализация
- При первом запуске создается расписание по умолчанию
- Загружаются все сотрудники из `employees.txt`
- Создается расписание на 2 месяца вперед на основе расписания по умолчанию

### 2. Еженедельный цикл

#### Пятница (конец рабочего дня, ~18:00)
- Бот отправляет всем сотрудникам напоминание:
  ```
  Напоминание: до воскресенья вечера укажите дни, когда вам нужно быть в офисе на следующей неделе.
  Используйте команду /set_week_days или ответьте на это сообщение списком дней (например: "пн, вт, чт")
  ```

#### Суббота-Воскресенье
- Бот собирает заявки от сотрудников на следующую неделю
- Сотрудники могут указать:
  - Дни, когда им нужно быть в офисе (даже если их нет в расписании по умолчанию)
  - Дни, которые они пропускают (даже если они есть в расписании по умолчанию)

#### Воскресенье вечером (после 20:00)
- Бот анализирует все заявки
- Обрабатывает очередь для каждого дня следующей недели (если есть свободные места)
- Формирует финальное расписание на неделю
- Рассылает всем сотрудникам информацию:
  ```
  Ваше расписание на неделю [даты]:
  
  Дни в офисе: Пн, Вт, Чт
  Дни удаленно: Ср, Пт
  
  Дополнительно запрошенные дни:
  ✅ Пт - место найдено
  ❌ Ср - свободного места не нашлось
  
  Свободные места:
  - Среда: 1 место(а)
  ```

### 3. Команды бота

#### `/start` или `/help`
- Показывает список доступных команд

#### `/set_week_days [даты]`
- Установить дни на следующую неделю
- Поддерживает даты: `/set_week_days 2024-12-23 2024-12-24 2024-12-26`
- Также поддерживает названия дней: `/set_week_days пн вт чт`
- Перезаписывает предыдущую заявку пользователя на ту же неделю

#### `/my_schedule`
- Показать свое расписание на текущую неделю
- Использует сохраненные расписания или строит из заявок

#### `/full_schedule [дата]`
- Показать полное расписание на дату (только для админов)

#### `/skip_day [дата]`
- Пропустить день в расписании (можно указать несколько дат)
- Пример: `/skip_day 2024-12-20`
- Пример: `/skip_day 2024-12-20 2024-12-21`
- Для текущей недели: удаляет из расписания, обрабатывает очередь
- Для следующей недели: добавляет в список пропусков

#### `/add_day [дата]`
- Запросить дополнительный день в офисе (можно указать несколько дат)
- Пример: `/add_day 2024-12-20`
- Пример: `/add_day 2024-12-20 2024-12-21`
- Для текущей недели: добавляет в расписание или в очередь, если места нет
- Для следующей недели: добавляет в список запрошенных дней

#### `/admin_add_employee [имя] @username`
- Добавить нового сотрудника (только для админов)
- Также можно: `/admin_add_employee [имя] [telegram_id]`
- Или ответить на сообщение: `/admin_add_employee [имя]`

#### `/admin_skip_day @username [дата]`
- Пропустить день для сотрудника (только для админов)
- Можно указать несколько дат

#### `/admin_add_day @username [дата]`
- Добавить день для сотрудника (только для админов)
- Можно указать несколько дат

#### `/admin_list_admins`
- Показать список администраторов с их username

#### `/admin_add_admin @username`
- Добавить администратора по username или telegram_id

### 4. Обработка заявок

#### Сбор заявок
- Бот хранит заявки в файле `requests/YYYY-MM-DD_requests.txt`
- Формат заявки:
  ```
  employee_name:telegram_id:week_start_date:days_requested:days_skipped
  ```
- Если пользователь отправляет несколько заявок на одну неделю, сохраняется только последняя

#### Формирование расписания
1. Начинаем с расписания по умолчанию
2. Применяем пропуски (удаляем сотрудников из дней)
3. Применяем дополнительные заявки (добавляем сотрудников в дни, если есть место)
4. Проверяем ограничение в 8 мест
5. Обрабатываем очередь для каждого дня (если есть свободные места)
6. Если мест не хватает - сотрудник работает удаленно или остается в очереди

### 5. Система очередей

#### Работа с очередью для текущей недели
- При использовании `/add_day` для текущей недели:
  - Если есть место - сотрудник добавляется в расписание
  - Если места нет - сотрудник добавляется в очередь (`data/queue/YYYY-MM-DD_queue.txt`)
- При использовании `/skip_day` для текущей недели:
  - Если сотрудник в расписании - удаляется, освобождается место
  - Если сотрудник в очереди - удаляется из очереди
  - После освобождения места автоматически обрабатывается очередь (первый из очереди добавляется)

#### Обработка очереди для следующей недели
- При формировании расписания в воскресенье вечером:
  - После применения всех заявок проверяется каждый день следующей недели
  - Если есть свободные места - обрабатывается очередь для этого дня
  - Первый из очереди автоматически добавляется в расписание

### 6. Уведомления

#### Автоматические напоминания
- Пятница 18:00 - напоминание о необходимости указать дни
- Воскресенье 20:00 - рассылка финального расписания

#### Уведомления о свободных местах
- После формирования расписания бот проверяет для каждого сотрудника:
  - Есть ли свободные места в дни, которых у него нет в расписании
  - Если есть - отправляет уведомление
- При освобождении места в текущей неделе:
  - Уведомляются все сотрудники (кроме тех, кто уже в офисе)
  - Первый из очереди автоматически добавляется и получает уведомление

### 7. Хранение истории
- Все расписания сохраняются в `schedules/YYYY-MM-DD.txt`
- История заявок в `requests/YYYY-MM-DD_requests.txt`
- Очереди в `queue/YYYY-MM-DD_queue.txt`
- Ретро-периоды доступны для просмотра через команды

### 8. Управление сотрудниками и администраторами
- Формат `employees.txt`: `manual_name:telegram_name:telegram_id:username`
- Ежедневно в 03:00 выполняется схлопывание дубликатов по `telegram_id`
- Администраторы хранятся в `data/admins.txt` (по одному ID на строку)
- Администраторы могут управлять расписанием других сотрудников через `/admin_skip_day` и `/admin_add_day`

## Технические детали

### Используемые библиотеки
- `aiogram` - для работы с Telegram Bot API
- `asyncio` - для асинхронной работы
- `datetime`, `pytz` - для работы с датами
- `schedule` или `APScheduler` - для планирования задач

### Структура файлов проекта
```
office_schedule_bot/
├── main.py                 # Основной файл бота
├── config.py               # Конфигурация (токены, настройки)
├── schedule_manager.py     # Управление расписаниями
├── employee_manager.py     # Управление сотрудниками
├── notification_manager.py # Управление уведомлениями
├── data/
│   ├── schedules/          # Файлы расписаний
│   ├── requests/           # Файлы заявок
│   └── employees.txt       # Список сотрудников
├── requirements.txt
├── README.md
└── ALGORITHM.md            # Этот файл
```

